<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f4f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: white;
            margin-top: 50px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eaeaea;
        }

        .total {
            font-weight: bold;
            font-size: 18px;
            text-align: right;
            margin-top: 20px;
        }

        .form-group {
            margin-top: 30px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .error {
            color: red;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .btn {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .success-message {
            text-align: center;
            color: green;
            font-weight: bold;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Your Online Cart</h2>
        <div class="item"><span>T-shirt</span><span>AED 20.00</span></div>
        <div class="item"><span>Shorts</span><span>AED 35.00</span></div>
        <div class="item"><span>Soap</span><span>AED 15.00</span></div>
        <div class="total">Total: AED 70.00</div>

        <div class="form-group">
            <label for="email">Enter your email to proceed:</label>
            <input type="email" id="email" placeholder="you@example.com" />
            <div class="error" id="emailError">Please enter a valid email address.</div>
        </div>

        <button class="btn" id="proceedBtn">Proceed to Payment</button>
        <div id="dropin-container"></div>
        <div class="success-message" id="successMessage">
            Proceeding to payment...
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://checkoutshopper-live.cdn.adyen.com/checkoutshopper/sdk/6.11.0/adyen.js"
        integrity="sha384-wwiuyx0VwdDwaHvlLtdCKeUuFCNIMDrWrQI24PdEMMMGgOZPHirMZfXHNgrk6DG5"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://checkoutshopper-live.cdn.adyen.com/checkoutshopper/sdk/6.11.0/adyen.css"
        integrity="sha384-grpuyJ9vAlVrx/mBLXLO3V2f9W3m5KKYx34MzigvvPqArvi0WqWoD/Pl++yf15EU" crossorigin="anonymous">
    <script>

        async function callsessions(input) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: "./session.php",
                    method: "POST",
                    contentType: "application/json",      // ðŸ‘ˆ Send as JSON
                    data: JSON.stringify(input),           // ðŸ‘ˆ Convert input to JSON string
                    success: function (response) {
                        try {
                            const parsed = JSON.parse(response);
                            resolve(parsed);
                        } catch (e) {
                            reject("Failed to parse session response: " + e);
                        }
                    },
                    error: function (xhr, status, error) {
                        reject("AJAX Error: " + error);
                    }
                });
            });
        }



        async function loadDropin(input) {

            var bin;

            var sessionResponse = await callsessions(input)
            console.log(sessionResponse)
            var sessionid = sessionResponse.id
            var sessionData = sessionResponse.sessionData
            var dropin;
            var inif = false;
            const globalConfiguration = {
                session: {
                    id: sessionid, // Unique identifier for the payment session.
                    sessionData: sessionData // The payment session data.
                },

                environment: 'test', // Change to 'live' for the live environment.
                amount: {
                    value: 10000,
                    currency: 'AED'
                },
                locale: 'en_US',
                countryCode: 'AE',
                clientKey: 'test_DNYUPHYAUJEWPEKUYET53S3U2EBHNJJD', // Public key used for client-side authentication: https://docs.adyen.com/development-resources/client-side-authentication
                // clientKey: 'live_G243FH7YG5DZHJR43FD365L24AWRKMPI',
                onPaymentCompleted: (result, component) => {
                    console.info(result, component);
                },
                onPaymentFailed: (result, component) => {
                    console.log('error', result)
                    console.info(result, component);

                },
                //   onSubmit: (element, component) => {
                //       console.log(element.data.paymentMethod)
                //       console.log(component)
                //       var vody = {
                //           "amount": {
                //               "currency": "AED",
                //               "value": 0
                //           },
                //           "reference": "m9d3rf8q",
                //           "paymentMethod": element.data.paymentMethod,
                //           "storePaymentMethod": "true",
                //           "shopperInteraction": "Ecommerce",
                //           // "shopperReference": "maher.daher@outlook.com",
                //           "recurringProcessingModel": "UnscheduledCardOnFile",
                //           "returnUrl": "http://127.0.0.1:8080/views/cart.html",
                //           "merchantAccount": "MaherAccountECOM"
                //       }
                //       console.log(vody)



                //       var settings = {
                //           "url": "./ecompayments.php",
                //           "method": "POST",
                //           "timeout": 0,
                //           "headers": {
                //               "Content-Type": "application/json"
                //           },
                //           "data": JSON.stringify({
                //               "amount": {
                //                   "currency": "AED",
                //                   "value": 0
                //               },
                //               "reference": "m9d3rf8q",
                //               "paymentMethod": element.data.paymentMethod,
                //               "storePaymentMethod": "true",
                //               "shopperInteraction": "Ecommerce",
                //               // "shopperReference": "maher.daher@outlook.com",
                //               "recurringProcessingModel": "UnscheduledCardOnFile",
                //               "returnUrl": "http://127.0.0.1:8080/views/cart.html",
                //               "merchantAccount": "MaherAccountECOM"
                //           }),
                //       };

                //       $.ajax(settings).done(function (response) {
                //           console.log(JSON.parse(response))
                //           console.log('Alias', JSON.parse(response).additionalData.alias);
                //           showResult(response)
                //       });
                //   },
                onError: (error, component) => {
                    console.error(error.name, error.message, error.stack, component);
                }
            };
            // All of the resources that you imported are properties of the window.
            // In this example you imported Card, GooglePay, and Paypal individually.
            const { AdyenCheckout, Dropin, Card, GooglePay, PayPal } = window.AdyenWeb;

            const checkout = await AdyenCheckout(globalConfiguration);
            // console.log("PM",checkout.paymentMethodsResponse);
            // checkout.paymentMethodsResponse={checkout.paymentMethodsResponse.storedPaymentMethods
            dropin = new Dropin(checkout

                //   , {


                //       paymentMethodsConfiguration: {
                //           card: {
                //               onBinValue: (component) => {
                //                   console.log('binval', component)
                //                   bin = component.binValue
                //                   console.log(bin)
                //               }
                //           }
                //       }

                //   }
            ).mount('#dropin-container');
        }

        function showResult(response) {
            console.log(response);

            if (JSON.parse(response).resultCode == "Authorised") {


                $('#dropin-container').html(`<div class="success-page adyen-checkout__status adyen-checkout__status--success"><img height="88" class="adyen-checkout__status__icon adyen-checkout__image adyen-checkout__image--loaded" src="https://checkoutshopper-test.adyen.com/checkoutshopper/images/components/success.gif" alt="Payment Successful"><span class="adyen-checkout__status__text">Thank you ${$('.name-input-field').val()} for registring!\nCard Alias: ${JSON.parse(response).additionalData.alias}</span></div>`);


            } else if (JSON.parse(response).resultCode == "Refused" || JSON.parse(response).resultCode == "Declined") {
                $('#dropin-container').html(`<div class=" success-page adyen-checkout__status adyen-checkout__status--error"><img class="adyen-checkout__status__icon adyen-checkout__image adyen-checkout__image--loaded" src="https://checkoutshopper-test.adyen.com/checkoutshopper/images/components/error.gif" alt="An unknown error occurred" height="88"><span class="adyen-checkout__status__text">Payment Unsuccessful : <b>${JSON.parse(response).additionalData.refusalReasonRaw}</b></span></div>`);
            }
        }

    </script>
    <script>
        $(document).ready(function () {
            $('#proceedBtn').click(function () {
                const email = $('#email').val().trim();
                const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;

                const input = {
                    merchantAccount: "MaherAccountECOM",
                    amount: {
                        value: 7000,
                        currency: "AED"
                    },
                    shopperReference : $('#email').val(),
                    returnUrl: "http://127.0.0.1:8080/page.html",
                    reference: "online-pay",
                    countryCode: "AE",
                    recurringProcessingModel: "CardOnFile",
                    shopperInteraction: "Ecommerce"
                };

                console.log('req',input)
                $('#proceedBtn').hide();
                loadDropin(input);

            });
        });
    </script>
</body>

</html>